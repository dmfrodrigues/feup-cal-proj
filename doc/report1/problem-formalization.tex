\chapter{Problem formalization}
In this chapter, we will make an effort to transform our specific problems into abstract (and to the greatest extent possible, classical) problems, in order to list all subproblems to be solved and possible solutions.
\section{Input}
There are two main inputs to this problem: a description of the map of the area the company serves (section \ref{input-map}); the list of vans (section \ref{input-vans}); the list of requested services for a given day (section \ref{input-services}).
\subsection{Map} \label{input-map}
We will be using maps from OpenStreetMap (OSM) to model the area \emph{PortoCityTransfers} serves.
Maps will be converted into graphs $G=(V,E, w)$, where:
\begin{itemize}
    \item Nodes $V$ represent positions on Earth.
    \item Edges $E$ represent roads traversable by automobiles.
    \item Weight function $w$ is the time it takes to cross an edge. Considering an estimated average distance between successive nodes of about $5 m$, and that traveling at a maximum speed of $120 km/h$ a vehicle would take $0.15 s$ to cross it, cost will be expressed in integer milliseconds which is deemed a unit with more than enough precision, while still being relatively easy to manage as well as fitting in a 32-bit unsigned integer.
\end{itemize}
We will have two graphs:
\begin{itemize}
    \item $G=(V,E,w)$ is the main map, with all the nodes ($|V|=185360$) and edges ($|E|=343617$).
    \item $G'=(V',E',w')$ is the helper map, which instead of having all edges, will only contain as edges what OSM calls "ways", thus allowing for faster path-finding. Thus, the number of nodes ($|V'|=43592$) and edges ($|E'|=54677$) will be significantly smaller.
\end{itemize}
We thus have as input data the directed weighted graph $G=(V,E,w)$.
\subsection{Vans} \label{input-vans}
A list of vans $v_i=(n)$ where $n$ is the capacity.
\subsection{Services} \label{input-services}
For each client, we need to know the origin, destination and the time the person can be picked up.
We thus have as input data a sequence of clients $c$ where each client $c=(u, v, t)$ can be picked at $u$ starting in time $t$, and must be dropped at $v$.
\section{Output}
Various rides $r$, where a ride is a triple $r=(v, C, \langle e \rangle)$. $v$ is the van that will fulfill that ride, $C$ is the set of clients satisfied by that ride and $\langle e \rangle = \langle e_1, e_2,...,e_{|e|} \rangle$ is the sequence of events in that ride. An event $e$ is a triple $e=(t, a, c)$ where $t$ is the time point of that event, $a$ is the type of event and $c$ is defined according to $a$:
\begin{itemize}
    \item $a=+1$: client $c$ will be picked up at $c.u$ at time $t$.
    \item $a=-1$: client $c$ will be dropped off at $c.v$ at time $t$.
    \item $a=0$: the van must be at node $c$ at time $t$.
\end{itemize}
Let $node(e)$ be the node where the van is supposed to be according to event $e$:
\begin{equation*}
    node(e)=\begin{dcases}
        e.c.u & : e.a = +1\\
        e.c.v & : e.a = -1\\
        e.c   & : e.a = 0
    \end{dcases}
\end{equation*}
\section{Restrictions}
The limits of index variables are implicitly limited sequences' sizes.
\begin{enumerate}
    \item $\{r.C : r \text{ is a ride}\}$ is a partition of the set of all clients (a client can only be satisfied once, and all clients must be satisfied).
    \item For a ride $r(v,C,\langle e \rangle)$:
    \begin{enumerate}
        \item It must start and end at the train station: $(e_1.a, e_1.c) = (e_{|e|}.a,e_{|e|}.c)=(0, \text{ train station})$
        \item The clients in $C$ are the same as those in the ride's events: $C=\{e.c : e.a \neq 0\}$
        \item Each client may only be picked up and dropped off once, and all clients must be served:
        \begin{alignat*}{2}
            \forall c \in C,
            &(\exists !e: e.c = c \wedge e.a = +1)\,\wedge \\
            &(\exists !e: e.c = c \wedge e.a = -1)
        \end{alignat*}
        \item The ride must be \emph{feasible}, i.e., there must be enough time between consecutive events for the van to travel from one to the other: $\forall i,\,dist(node(e_i), node(e_{i+1})) \leq e_{i+1}.t - e_i.t$
        \item At every moment, the number of clients inside a van must not be larger than its capacity:
        \begin{equation*}
            \forall i,~\sum_{j=1}^{i}{e_i.a} \leq v.n
        \end{equation*}
    \end{enumerate}
    \item For a van $v$:
    \begin{enumerate}
        \item There are no overlapping rides: $\forall r, r',~r \neq r' \wedge v = v' \iff \min\{e_{|e|}.t,e'_{|e'|}.t\} \leq \max\{e_1.t,e'_1.t\}$
    \end{enumerate}
\end{enumerate}
\section{Objective function}
Let $pick(c)$ be the event where $c$ is picked up, and $drop(c)$ the event where $c$ is dropped off. Our objective function is
\begin{alignat*}{2}
    \text{Total time it took}        ~~& T        &&= \sum_{c \text{ client}}{drop(c).t - pick(c).t} \\
    \text{Minimum time it could take}~~& T_{\min} &&= \sum_{c \text{ client}}{dist(node(drop(c)), node(pick(c)))} \\
    \text{Extra time we must minimize}~~& \Delta T &&= T - T_{\min}
\end{alignat*}
\begin{equation*}
    \min \Delta T
\end{equation*}

